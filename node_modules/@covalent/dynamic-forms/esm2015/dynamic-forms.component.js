/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,uselessCode} checked by tsc
 */
import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef, ContentChildren, QueryList } from '@angular/core';
import { FormBuilder } from '@angular/forms';
import { TdDynamicFormsService } from './services/dynamic-forms.service';
import { TdDynamicFormsErrorTemplate } from './dynamic-element.component';
import { timer, Subject } from 'rxjs';
import { takeUntil, filter } from 'rxjs/operators';
export class TdDynamicFormsComponent {
    /**
     * @param {?} _formBuilder
     * @param {?} _dynamicFormsService
     * @param {?} _changeDetectorRef
     */
    constructor(_formBuilder, _dynamicFormsService, _changeDetectorRef) {
        this._formBuilder = _formBuilder;
        this._dynamicFormsService = _dynamicFormsService;
        this._changeDetectorRef = _changeDetectorRef;
        this._renderedElements = [];
        this._templateMap = new Map();
        this._destroy$ = new Subject();
        this._destroyControl$ = new Subject();
        this.dynamicForm = this._formBuilder.group({});
    }
    /**
     * elements: ITdDynamicElementConfig[]
     * JS Object that will render the elements depending on its config.
     * [name] property is required.
     * @param {?} elements
     * @return {?}
     */
    set elements(elements) {
        if (elements) {
            this._elements = elements;
        }
        else {
            this._elements = [];
        }
        this._rerenderElements();
    }
    /**
     * @return {?}
     */
    get elements() {
        return this._renderedElements;
    }
    /**
     * Getter property for dynamic [FormGroup].
     * @return {?}
     */
    get form() {
        return this.dynamicForm;
    }
    /**
     * Getter property for [valid] of dynamic [FormGroup].
     * @return {?}
     */
    get valid() {
        if (this.dynamicForm) {
            return this.dynamicForm.valid;
        }
        return false;
    }
    /**
     * Getter property for [value] of dynamic [FormGroup].
     * @return {?}
     */
    get value() {
        if (this.dynamicForm) {
            return this.dynamicForm.value;
        }
        return {};
    }
    /**
     * Getter property for [errors] of dynamic [FormGroup].
     * @return {?}
     */
    get errors() {
        if (this.dynamicForm) {
            /** @type {?} */
            let errors = {};
            for (let name in this.dynamicForm.controls) {
                errors[name] = this.dynamicForm.controls[name].errors;
            }
            return errors;
        }
        return {};
    }
    /**
     * Getter property for [controls] of dynamic [FormGroup].
     * @return {?}
     */
    get controls() {
        if (this.dynamicForm) {
            return this.dynamicForm.controls;
        }
        return {};
    }
    /**
     * @return {?}
     */
    ngAfterContentInit() {
        this._updateErrorTemplates();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
        this._destroyControl$.complete();
    }
    /**
     * Refreshes the form and rerenders all validator/element modifications.
     * @return {?}
     */
    refresh() {
        this._rerenderElements();
        this._updateErrorTemplates();
    }
    /**
     * Getter method for error template references
     * @param {?} name
     * @return {?}
     */
    getErrorTemplateRef(name) {
        return this._templateMap.get(name);
    }
    /**
     * Loads error templates and sets them in a map for faster access.
     * @return {?}
     */
    _updateErrorTemplates() {
        this._templateMap = new Map();
        for (let i = 0; i < this._errorTemplates.toArray().length; i++) {
            this._templateMap.set(this._errorTemplates.toArray()[i].tdDynamicFormsError, this._errorTemplates.toArray()[i].templateRef);
        }
    }
    /**
     * @return {?}
     */
    _rerenderElements() {
        this._clearRemovedElements();
        this._renderedElements = [];
        /** @type {?} */
        let duplicates = [];
        this._elements.forEach((elem) => {
            this._dynamicFormsService.validateDynamicElementName(elem.name);
            if (duplicates.indexOf(elem.name) > -1) {
                throw new Error(`Dynamic element name: "${elem.name}" is duplicated`);
            }
            duplicates.push(elem.name);
            /** @type {?} */
            let dynamicElement = this.dynamicForm.get(elem.name);
            if (!dynamicElement) {
                this.dynamicForm.addControl(elem.name, this._dynamicFormsService.createFormControl(elem));
                this._subscribeToControlStatusChanges(elem.name);
            }
            else {
                dynamicElement.setValue(elem.default);
                dynamicElement.markAsPristine();
                dynamicElement.markAsUntouched();
                if (elem.disabled) {
                    dynamicElement.disable();
                }
                else {
                    dynamicElement.enable();
                }
                dynamicElement.setValidators(this._dynamicFormsService.createValidators(elem));
            }
            // copy objects so they are only changes when calling this method
            this._renderedElements.push(Object.assign({}, elem));
        });
        // call a change detection since the whole form might change
        this._changeDetectorRef.detectChanges();
        timer().toPromise().then(() => {
            // call a markForCheck so elements are rendered correctly in OnPush
            this._changeDetectorRef.markForCheck();
        });
    }
    /**
     * @return {?}
     */
    _clearRemovedElements() {
        for (let i = 0; i < this._renderedElements.length; i++) {
            for (let j = 0; j < this._elements.length; j++) {
                // check if the name of the element is still there removed
                if (this._renderedElements[i].name === this._elements[j].name) {
                    delete this._renderedElements[i];
                    break;
                }
            }
        }
        // remove elements that were removed from the array
        this._renderedElements.forEach((elem) => {
            this._destroyControl$.next(elem.name);
            this.dynamicForm.removeControl(elem.name);
        });
    }
    // Updates component when manually adding errors to controls
    /**
     * @param {?} elementName
     * @return {?}
     */
    _subscribeToControlStatusChanges(elementName) {
        /** @type {?} */
        const control = this.controls[elementName];
        /** @type {?} */
        const controlDestroyed$ = this._destroyControl$
            .pipe(filter((destroyedElementName) => destroyedElementName === elementName));
        control.statusChanges
            .pipe(takeUntil(this._destroy$), takeUntil(controlDestroyed$)).subscribe(() => {
            this._changeDetectorRef.markForCheck();
        });
    }
}
TdDynamicFormsComponent.decorators = [
    { type: Component, args: [{
                selector: 'td-dynamic-forms',
                template: "<form [formGroup]=\"dynamicForm\" novalidate>\n  <div class=\"td-dynamic-form-wrapper\">\n    <ng-template let-element ngFor [ngForOf]=\"elements\">\n      <div class=\"td-dynamic-element-wrapper\"\n          [style.max-width.%]=\"element.flex ? element.flex : 100\"\n          [style.flex]=\"'1 1 ' + (element.flex ? element.flex : 100) + '%'\"\n          [style.-ms-flex]=\"'1 1 ' + (element.flex ? element.flex : 100) + '%'\"\n          [style.-webkit-box-flex]=\"1\">\n        <td-dynamic-element\n          #dynamicElement\n          *ngIf=\"dynamicForm.controls[element.name]\"\n          [formControlName]=\"element.name\"\n          [dynamicControl]=\"dynamicForm.controls[element.name]\"\n          [id]=\"element.name\"\n          [name]=\"element.name\"\n          [label]=\"element.label || element.name\"\n          [hint]=\"element.hint\"\n          [type]=\"element.type\"\n          [required]=\"element.required\"\n          [min]=\"element.min\"\n          [max]=\"element.max\"\n          [minLength]=\"element.minLength\"\n          [maxLength]=\"element.maxLength\"\n          [selections]=\"element.selections\"\n          [multiple]=\"element.multiple\"\n          [errorMessageTemplate]=\"getErrorTemplateRef(element.name)\">\n        </td-dynamic-element>\n      </div>\n    </ng-template>\n  </div>\n  <ng-content></ng-content>\n</form>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".td-dynamic-form-wrapper{-ms-flex-wrap:wrap;flex-wrap:wrap;box-sizing:border-box;display:-ms-flexbox;display:flex;-ms-flex-direction:row;flex-direction:row;-ms-flex-align:center;align-items:center;-ms-flex-line-pack:center;align-content:center;max-width:100%;-ms-flex-pack:start;justify-content:start}.td-dynamic-form-wrapper ::ng-deep .mat-form-field-infix{width:auto}.td-dynamic-form-wrapper ::ng-deep .td-dynamic-element-hint{font-size:75%;display:block}.td-dynamic-form-wrapper .td-dynamic-element-wrapper{max-height:100%;box-sizing:border-box;position:relative;padding:4px 4px 8px}"]
            }] }
];
/** @nocollapse */
TdDynamicFormsComponent.ctorParameters = () => [
    { type: FormBuilder },
    { type: TdDynamicFormsService },
    { type: ChangeDetectorRef }
];
TdDynamicFormsComponent.propDecorators = {
    _errorTemplates: [{ type: ContentChildren, args: [TdDynamicFormsErrorTemplate,] }],
    elements: [{ type: Input, args: ['elements',] }]
};
if (false) {
    /** @type {?} */
    TdDynamicFormsComponent.prototype._renderedElements;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._elements;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._templateMap;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._destroy$;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._destroyControl$;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._errorTemplates;
    /** @type {?} */
    TdDynamicFormsComponent.prototype.dynamicForm;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._formBuilder;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._dynamicFormsService;
    /** @type {?} */
    TdDynamicFormsComponent.prototype._changeDetectorRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1mb3Jtcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AY292YWxlbnQvZHluYW1pYy1mb3Jtcy8iLCJzb3VyY2VzIjpbImR5bmFtaWMtZm9ybXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxpQkFBaUIsRUFBRSxlQUFlLEVBQ2hFLFNBQVMsRUFBK0IsTUFBTSxlQUFlLENBQUM7QUFDcEYsT0FBTyxFQUFhLFdBQVcsRUFBbUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RSxPQUFPLEVBQUUscUJBQXFCLEVBQTJCLE1BQU0sa0NBQWtDLENBQUM7QUFDbEcsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFFMUUsT0FBTyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVFuRCxNQUFNLE9BQU8sdUJBQXVCOzs7Ozs7SUFnRmxDLFlBQW9CLFlBQXlCLEVBQ3pCLG9CQUEyQyxFQUMzQyxrQkFBcUM7UUFGckMsaUJBQVksR0FBWixZQUFZLENBQWE7UUFDekIseUJBQW9CLEdBQXBCLG9CQUFvQixDQUF1QjtRQUMzQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW1CO1FBaEZqRCxzQkFBaUIsR0FBOEIsRUFBRSxDQUFDO1FBRWxELGlCQUFZLEdBQWtDLElBQUksR0FBRyxFQUE0QixDQUFDO1FBQ2xGLGNBQVMsR0FBaUIsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN4QyxxQkFBZ0IsR0FBb0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQTZFeEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7OztJQXBF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Q0FBQyxDQUFDO1FBQzVDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7Ozs7O0lBR08sZ0NBQWdDLENBQUMsV0FBbUI7O2NBQ3BELE9BQU8sR0FBb0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7O2NBRXJELGlCQUFpQixHQUFvQixJQUFJLENBQUMsZ0JBQWdCO2FBQzdELElBQUksQ0FDSCxNQUFNLENBQUMsQ0FBQyxvQkFBNEIsRUFBRSxFQUFFLENBQUMsb0JBQW9CLEtBQUssV0FBVyxDQUFDLENBQy9FO1FBRUgsT0FBTyxDQUFDLGFBQWE7YUFDbEIsSUFBSSxDQUNILFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQ3pCLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUM3QixDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDZixJQUFJLENBQUMsa0JBQWtCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOzs7WUF2TUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxrQkFBa0I7Z0JBQzVCLGcyQ0FBNkM7Z0JBRTdDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOzthQUNoRDs7OztZQWJtQixXQUFXO1lBRXRCLHFCQUFxQjtZQUpzQixpQkFBaUI7Ozs4QkF3QmxFLGVBQWUsU0FBQywyQkFBMkI7dUJBUTNDLEtBQUssU0FBQyxVQUFVOzs7O0lBZGpCLG9EQUEwRDs7SUFDMUQsNENBQTZDOztJQUM3QywrQ0FBMEY7O0lBQzFGLDRDQUFnRDs7SUFDaEQsbURBQTBEOztJQUUxRCxrREFBc0c7O0lBQ3RHLDhDQUF1Qjs7SUF1RVgsK0NBQWlDOztJQUNqQyx1REFBbUQ7O0lBQ25ELHFEQUE2QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29udGVudENoaWxkcmVuLFxuICAgICAgICAgVGVtcGxhdGVSZWYsIFF1ZXJ5TGlzdCwgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGb3JtR3JvdXAsIEZvcm1CdWlsZGVyLCBBYnN0cmFjdENvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbmltcG9ydCB7IFRkRHluYW1pY0Zvcm1zU2VydmljZSwgSVRkRHluYW1pY0VsZW1lbnRDb25maWcgfSBmcm9tICcuL3NlcnZpY2VzL2R5bmFtaWMtZm9ybXMuc2VydmljZSc7XG5pbXBvcnQgeyBUZER5bmFtaWNGb3Jtc0Vycm9yVGVtcGxhdGUgfSBmcm9tICcuL2R5bmFtaWMtZWxlbWVudC5jb21wb25lbnQnO1xuXG5pbXBvcnQgeyB0aW1lciwgU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3RkLWR5bmFtaWMtZm9ybXMnLFxuICB0ZW1wbGF0ZVVybDogJy4vZHluYW1pYy1mb3Jtcy5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL2R5bmFtaWMtZm9ybXMuY29tcG9uZW50LnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIFRkRHluYW1pY0Zvcm1zQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgT25EZXN0cm95IHtcblxuICBwcml2YXRlIF9yZW5kZXJlZEVsZW1lbnRzOiBJVGREeW5hbWljRWxlbWVudENvbmZpZ1tdID0gW107XG4gIHByaXZhdGUgX2VsZW1lbnRzOiBJVGREeW5hbWljRWxlbWVudENvbmZpZ1tdO1xuICBwcml2YXRlIF90ZW1wbGF0ZU1hcDogTWFwPHN0cmluZywgVGVtcGxhdGVSZWY8YW55Pj4gPSBuZXcgTWFwPHN0cmluZywgVGVtcGxhdGVSZWY8YW55Pj4oKTtcbiAgcHJpdmF0ZSBfZGVzdHJveSQ6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0KCk7XG4gIHByaXZhdGUgX2Rlc3Ryb3lDb250cm9sJDogU3ViamVjdDxzdHJpbmc+ID0gbmV3IFN1YmplY3QoKTtcblxuICBAQ29udGVudENoaWxkcmVuKFRkRHluYW1pY0Zvcm1zRXJyb3JUZW1wbGF0ZSkgX2Vycm9yVGVtcGxhdGVzOiBRdWVyeUxpc3Q8VGREeW5hbWljRm9ybXNFcnJvclRlbXBsYXRlPjtcbiAgZHluYW1pY0Zvcm06IEZvcm1Hcm91cDtcblxuICAvKipcbiAgICogZWxlbWVudHM6IElUZER5bmFtaWNFbGVtZW50Q29uZmlnW11cbiAgICogSlMgT2JqZWN0IHRoYXQgd2lsbCByZW5kZXIgdGhlIGVsZW1lbnRzIGRlcGVuZGluZyBvbiBpdHMgY29uZmlnLlxuICAgKiBbbmFtZV0gcHJvcGVydHkgaXMgcmVxdWlyZWQuXG4gICAqL1xuICBASW5wdXQoJ2VsZW1lbnRzJylcbiAgc2V0IGVsZW1lbnRzKGVsZW1lbnRzOiBJVGREeW5hbWljRWxlbWVudENvbmZpZ1tdKSB7XG4gICAgaWYgKGVsZW1lbnRzKSB7XG4gICAgICB0aGlzLl9lbGVtZW50cyA9IGVsZW1lbnRzO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9lbGVtZW50cyA9IFtdO1xuICAgIH1cbiAgICB0aGlzLl9yZXJlbmRlckVsZW1lbnRzKCk7XG4gIH1cbiAgZ2V0IGVsZW1lbnRzKCk6IElUZER5bmFtaWNFbGVtZW50Q29uZmlnW10ge1xuICAgIHJldHVybiB0aGlzLl9yZW5kZXJlZEVsZW1lbnRzO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHRlciBwcm9wZXJ0eSBmb3IgZHluYW1pYyBbRm9ybUdyb3VwXS5cbiAgICovXG4gIGdldCBmb3JtKCk6IEZvcm1Hcm91cCB7XG4gICAgcmV0dXJuIHRoaXMuZHluYW1pY0Zvcm07XG4gIH1cblxuICAvKipcbiAgICogR2V0dGVyIHByb3BlcnR5IGZvciBbdmFsaWRdIG9mIGR5bmFtaWMgW0Zvcm1Hcm91cF0uXG4gICAqL1xuICBnZXQgdmFsaWQoKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMuZHluYW1pY0Zvcm0pIHtcbiAgICAgIHJldHVybiB0aGlzLmR5bmFtaWNGb3JtLnZhbGlkO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogR2V0dGVyIHByb3BlcnR5IGZvciBbdmFsdWVdIG9mIGR5bmFtaWMgW0Zvcm1Hcm91cF0uXG4gICAqL1xuICBnZXQgdmFsdWUoKTogYW55IHtcbiAgICBpZiAodGhpcy5keW5hbWljRm9ybSkge1xuICAgICAgcmV0dXJuIHRoaXMuZHluYW1pY0Zvcm0udmFsdWU7XG4gICAgfVxuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXR0ZXIgcHJvcGVydHkgZm9yIFtlcnJvcnNdIG9mIGR5bmFtaWMgW0Zvcm1Hcm91cF0uXG4gICAqL1xuICBnZXQgZXJyb3JzKCk6IHsgW25hbWU6IHN0cmluZ106IGFueSB9IHtcbiAgICBpZiAodGhpcy5keW5hbWljRm9ybSkge1xuICAgICAgbGV0IGVycm9yczoge1tuYW1lOiBzdHJpbmddOiBhbnl9ID0ge307XG4gICAgICBmb3IgKGxldCBuYW1lIGluIHRoaXMuZHluYW1pY0Zvcm0uY29udHJvbHMpIHtcbiAgICAgICAgZXJyb3JzW25hbWVdID0gdGhpcy5keW5hbWljRm9ybS5jb250cm9sc1tuYW1lXS5lcnJvcnM7XG4gICAgICB9XG4gICAgICByZXR1cm4gZXJyb3JzO1xuICAgIH1cbiAgICByZXR1cm4ge307XG4gIH1cblxuICAvKipcbiAgICogR2V0dGVyIHByb3BlcnR5IGZvciBbY29udHJvbHNdIG9mIGR5bmFtaWMgW0Zvcm1Hcm91cF0uXG4gICAqL1xuICBnZXQgY29udHJvbHMoKToge1trZXk6IHN0cmluZ106IEFic3RyYWN0Q29udHJvbH0ge1xuICAgIGlmICh0aGlzLmR5bmFtaWNGb3JtKSB7XG4gICAgICByZXR1cm4gdGhpcy5keW5hbWljRm9ybS5jb250cm9scztcbiAgICB9XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBfZm9ybUJ1aWxkZXI6IEZvcm1CdWlsZGVyLFxuICAgICAgICAgICAgICBwcml2YXRlIF9keW5hbWljRm9ybXNTZXJ2aWNlOiBUZER5bmFtaWNGb3Jtc1NlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgX2NoYW5nZURldGVjdG9yUmVmOiBDaGFuZ2VEZXRlY3RvclJlZikge1xuICAgIHRoaXMuZHluYW1pY0Zvcm0gPSB0aGlzLl9mb3JtQnVpbGRlci5ncm91cCh7fSk7XG4gIH1cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5fdXBkYXRlRXJyb3JUZW1wbGF0ZXMoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2Rlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95JC5jb21wbGV0ZSgpO1xuICAgIHRoaXMuX2Rlc3Ryb3lDb250cm9sJC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZnJlc2hlcyB0aGUgZm9ybSBhbmQgcmVyZW5kZXJzIGFsbCB2YWxpZGF0b3IvZWxlbWVudCBtb2RpZmljYXRpb25zLlxuICAgKi9cbiAgcmVmcmVzaCgpOiB2b2lkIHtcbiAgICB0aGlzLl9yZXJlbmRlckVsZW1lbnRzKCk7XG4gICAgdGhpcy5fdXBkYXRlRXJyb3JUZW1wbGF0ZXMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXR0ZXIgbWV0aG9kIGZvciBlcnJvciB0ZW1wbGF0ZSByZWZlcmVuY2VzXG4gICAqL1xuICBnZXRFcnJvclRlbXBsYXRlUmVmKG5hbWU6IHN0cmluZyk6IFRlbXBsYXRlUmVmPGFueT4ge1xuICAgIHJldHVybiB0aGlzLl90ZW1wbGF0ZU1hcC5nZXQobmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZHMgZXJyb3IgdGVtcGxhdGVzIGFuZCBzZXRzIHRoZW0gaW4gYSBtYXAgZm9yIGZhc3RlciBhY2Nlc3MuXG4gICAqL1xuICBwcml2YXRlIF91cGRhdGVFcnJvclRlbXBsYXRlcygpOiB2b2lkIHtcbiAgICB0aGlzLl90ZW1wbGF0ZU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBUZW1wbGF0ZVJlZjxhbnk+PigpO1xuICAgIGZvciAobGV0IGk6IG51bWJlciA9IDA7IGkgPCB0aGlzLl9lcnJvclRlbXBsYXRlcy50b0FycmF5KCkubGVuZ3RoOyBpKyspIHtcbiAgICAgIHRoaXMuX3RlbXBsYXRlTWFwLnNldChcbiAgICAgICAgdGhpcy5fZXJyb3JUZW1wbGF0ZXMudG9BcnJheSgpW2ldLnRkRHluYW1pY0Zvcm1zRXJyb3IsXG4gICAgICAgIHRoaXMuX2Vycm9yVGVtcGxhdGVzLnRvQXJyYXkoKVtpXS50ZW1wbGF0ZVJlZixcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfcmVyZW5kZXJFbGVtZW50cygpOiB2b2lkIHtcbiAgICB0aGlzLl9jbGVhclJlbW92ZWRFbGVtZW50cygpO1xuICAgIHRoaXMuX3JlbmRlcmVkRWxlbWVudHMgPSBbXTtcbiAgICBsZXQgZHVwbGljYXRlczogc3RyaW5nW10gPSBbXTtcbiAgICB0aGlzLl9lbGVtZW50cy5mb3JFYWNoKChlbGVtOiBJVGREeW5hbWljRWxlbWVudENvbmZpZykgPT4ge1xuICAgICAgdGhpcy5fZHluYW1pY0Zvcm1zU2VydmljZS52YWxpZGF0ZUR5bmFtaWNFbGVtZW50TmFtZShlbGVtLm5hbWUpO1xuICAgICAgaWYgKGR1cGxpY2F0ZXMuaW5kZXhPZihlbGVtLm5hbWUpID4gLTEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEeW5hbWljIGVsZW1lbnQgbmFtZTogXCIke2VsZW0ubmFtZX1cIiBpcyBkdXBsaWNhdGVkYCk7XG4gICAgICB9XG4gICAgICBkdXBsaWNhdGVzLnB1c2goZWxlbS5uYW1lKTtcbiAgICAgIGxldCBkeW5hbWljRWxlbWVudDogQWJzdHJhY3RDb250cm9sID0gdGhpcy5keW5hbWljRm9ybS5nZXQoZWxlbS5uYW1lKTtcbiAgICAgIGlmICghZHluYW1pY0VsZW1lbnQpIHtcbiAgICAgICAgdGhpcy5keW5hbWljRm9ybS5hZGRDb250cm9sKGVsZW0ubmFtZSwgdGhpcy5fZHluYW1pY0Zvcm1zU2VydmljZS5jcmVhdGVGb3JtQ29udHJvbChlbGVtKSk7XG4gICAgICAgIHRoaXMuX3N1YnNjcmliZVRvQ29udHJvbFN0YXR1c0NoYW5nZXMoZWxlbS5uYW1lKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGR5bmFtaWNFbGVtZW50LnNldFZhbHVlKGVsZW0uZGVmYXVsdCk7XG4gICAgICAgIGR5bmFtaWNFbGVtZW50Lm1hcmtBc1ByaXN0aW5lKCk7XG4gICAgICAgIGR5bmFtaWNFbGVtZW50Lm1hcmtBc1VudG91Y2hlZCgpO1xuICAgICAgICBpZiAoZWxlbS5kaXNhYmxlZCkge1xuICAgICAgICAgIGR5bmFtaWNFbGVtZW50LmRpc2FibGUoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBkeW5hbWljRWxlbWVudC5lbmFibGUoKTtcbiAgICAgICAgfVxuICAgICAgICBkeW5hbWljRWxlbWVudC5zZXRWYWxpZGF0b3JzKHRoaXMuX2R5bmFtaWNGb3Jtc1NlcnZpY2UuY3JlYXRlVmFsaWRhdG9ycyhlbGVtKSk7XG4gICAgICB9XG4gICAgICAvLyBjb3B5IG9iamVjdHMgc28gdGhleSBhcmUgb25seSBjaGFuZ2VzIHdoZW4gY2FsbGluZyB0aGlzIG1ldGhvZFxuICAgICAgdGhpcy5fcmVuZGVyZWRFbGVtZW50cy5wdXNoKE9iamVjdC5hc3NpZ24oe30sIGVsZW0pKTtcbiAgICB9KTtcbiAgICAvLyBjYWxsIGEgY2hhbmdlIGRldGVjdGlvbiBzaW5jZSB0aGUgd2hvbGUgZm9ybSBtaWdodCBjaGFuZ2VcbiAgICB0aGlzLl9jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgdGltZXIoKS50b1Byb21pc2UoKS50aGVuKCgpID0+IHtcbiAgICAgIC8vIGNhbGwgYSBtYXJrRm9yQ2hlY2sgc28gZWxlbWVudHMgYXJlIHJlbmRlcmVkIGNvcnJlY3RseSBpbiBPblB1c2hcbiAgICAgIHRoaXMuX2NoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfY2xlYXJSZW1vdmVkRWxlbWVudHMoKTogdm9pZCB7XG4gICAgZm9yIChsZXQgaTogbnVtYmVyID0gMDsgaSA8IHRoaXMuX3JlbmRlcmVkRWxlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGZvciAobGV0IGo6IG51bWJlciA9IDA7IGogPCB0aGlzLl9lbGVtZW50cy5sZW5ndGg7IGorKykge1xuICAgICAgICAvLyBjaGVjayBpZiB0aGUgbmFtZSBvZiB0aGUgZWxlbWVudCBpcyBzdGlsbCB0aGVyZSByZW1vdmVkXG4gICAgICAgIGlmICh0aGlzLl9yZW5kZXJlZEVsZW1lbnRzW2ldLm5hbWUgPT09IHRoaXMuX2VsZW1lbnRzW2pdLm5hbWUpIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fcmVuZGVyZWRFbGVtZW50c1tpXTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICAvLyByZW1vdmUgZWxlbWVudHMgdGhhdCB3ZXJlIHJlbW92ZWQgZnJvbSB0aGUgYXJyYXlcbiAgICB0aGlzLl9yZW5kZXJlZEVsZW1lbnRzLmZvckVhY2goKGVsZW06IElUZER5bmFtaWNFbGVtZW50Q29uZmlnKSA9PiB7XG4gICAgICB0aGlzLl9kZXN0cm95Q29udHJvbCQubmV4dChlbGVtLm5hbWUpO1xuICAgICAgdGhpcy5keW5hbWljRm9ybS5yZW1vdmVDb250cm9sKGVsZW0ubmFtZSk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBVcGRhdGVzIGNvbXBvbmVudCB3aGVuIG1hbnVhbGx5IGFkZGluZyBlcnJvcnMgdG8gY29udHJvbHNcbiAgcHJpdmF0ZSBfc3Vic2NyaWJlVG9Db250cm9sU3RhdHVzQ2hhbmdlcyhlbGVtZW50TmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgY29udHJvbDogQWJzdHJhY3RDb250cm9sID0gdGhpcy5jb250cm9sc1tlbGVtZW50TmFtZV07XG5cbiAgICBjb25zdCBjb250cm9sRGVzdHJveWVkJDogT2JzZXJ2YWJsZTxhbnk+ID0gdGhpcy5fZGVzdHJveUNvbnRyb2wkXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKChkZXN0cm95ZWRFbGVtZW50TmFtZTogc3RyaW5nKSA9PiBkZXN0cm95ZWRFbGVtZW50TmFtZSA9PT0gZWxlbWVudE5hbWUpLFxuICAgICAgKTtcblxuICAgIGNvbnRyb2wuc3RhdHVzQ2hhbmdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgICAgIHRha2VVbnRpbChjb250cm9sRGVzdHJveWVkJCksXG4gICAgICApLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuX2NoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSk7XG4gIH1cbn1cbiJdfQ==